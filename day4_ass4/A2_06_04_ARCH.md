# A2_06_04 — Architecture, Memory Layout & Flowchart

This document explains the architecture, memory layout, threading/IO model and includes a Mermaid flowchart (plus ASCII fallback) for `A2_06_04.c` (Memory Mapping assignment).

## Architecture overview

- Language: C (POSIX/Linux system calls)
- Primary components:
  - File creation & allocation: `open`, `fallocate` to create `bigfile.bin` of 8GB.
  - Memory mapping: `mmap(NULL, FILE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0)`.
  - Random writer: `lseek(fd, offset, SEEK_SET)` + `write(fd, &X, 1)`.
  - Verifier: read the byte via `mapped_file[offset]` and compare.
- No threads used — single-threaded program performing interleaved file & memory accesses.

## Data shapes & memory layout

- `FILE_SIZE` = 8 * 1024 * 1024 * 1024 bytes (8GB).
- The mapping returns a pointer `uint8_t *mapped_file` that indexes 0..FILE_SIZE-1.
- Pages are backed by the file on disk; initial mapping does not populate pages in RAM until they are touched.

## Behavior contract

- Input: none (program creates `bigfile.bin`).
- Output: repeated verification lines for each random write-read cycle.
- Error modes:
  - `open` failure: insufficient permissions or path issues.
  - `fallocate` failure: insufficient disk space, filesystem incompatibility.
  - `mmap` failure: `ENOMEM` or resource limits.
  - `write`/`lseek` failure: I/O errors or invalid offsets.
  - Accessing `mapped_file[offset]` after `munmap` or if `mmap` failed leads to undefined behavior.

## Flowchart (Mermaid)

```mermaid
flowchart TD
  Start[Start]
  A[open("bigfile.bin")]
  B[fallocate(fd, FILE_SIZE)]
  C[mmap(FILE_SIZE, MAP_SHARED)]
  D{mapping succeeded?}
  E[loop: pick random offset & byte]
  F[lseek(fd, offset)]
  G[write(fd, &X, 1)]
  H[read mapped_file[offset]]
  I{X == X'}
  J[print Verified]
  K[print ERROR & exit]
  L[munmap & close]
  End[Exit]

  Start --> A --> B --> C --> D
  D -- yes --> E --> F --> G --> H --> I
  I -- yes --> J --> E
  I -- no --> K --> L --> End
  D -- no --> K
```

## ASCII fallback flow

Start -> open file -> fallocate -> mmap -> loop: choose offset\n -> lseek -> write -> read mapped memory -> compare -> print Verified or ERROR -> cleanup -> exit

## Performance & VM effects

- Page faults: Touching a page for the first time triggers a page fault; if the page is not present in RAM it results in disk I/O (major fault). With random access across an 8GB address space and limited RAM, many major page faults are expected.
- Page cache: Writes go through the page cache. Using `write()` and `MAP_SHARED` ensures the page cache is updated; reads via the mapping reference the same page cache.
- I/O overhead: Random writes cause random disk I/O and poor throughput compared to sequential writes.

## Practical tips for maintainers

- Development: during development change `FILE_SIZE` to a small value (e.g., 64MiB) to avoid allocating 8GB.
- RNG: Use a 64-bit-aware RNG for offsets. Example fix: combine `rand()` calls or use `random()` and `srandom()`.
- SIGBUS: accessing a mapping can raise `SIGBUS` if the underlying file is truncated; handle with a signal handler or ensure nobody truncates the file.
- Cleanup: ensure `munmap` and `close` are called in error paths to avoid resource leaks. Use `atexit` for defensive cleanup.

## Security & permissions

- File permissions set to 0666 so any user could read/write the file while it exists. Use stricter permissions if needed.
- Because the program writes arbitrary offsets in a file, avoid running as root unless necessary.

## Small improvements you might apply

- Use `posix_fallocate` for portability where `fallocate` is not available.
- Use `clock_gettime(CLOCK_MONOTONIC, ..)` to time page-fault events or per-iteration latency.
- Use `pread`/`pwrite` for a purely descriptor-based test (no mapping) to compare cost of mapped vs. buffered I/O.

---

If you'd like, I can:
- Patch `A2_06_04.c` to use a smaller default `FILE_SIZE` for development and switch to 64-bit-safe offset generation.
- Add a small `Makefile` with `run-small` target to test with a reduced file size.

Say "apply patch" to change the source for quick testing, or "done" to finish.